import React, { useState, useEffect, useRef } from 'react';
import { Play, Mic, Volume2, Check, X, Trophy, Clock, ArrowRight, RotateCcw, Home, Award, AlertCircle } from 'lucide-react';

// --- Data & Content ---
const vocabularyData = [
  { id: 1, word: "debate", ipa: "[dÉª`bet]", pos: "vt. vi.", meaning: "è¾¯è«–", sentence: "At the school assembly, the student council debated the issue of adding a student-run cafÃ© on campus.", mnemonic: "De (åº•ä¸‹) + bate (æ‰“) -> å…©æ–¹åœ¨åº•ä¸‹ç”¨å˜´å·´äº’æ‰“ -> è¾¯è«–" },
  { id: 2, word: "penalty", ipa: "[`pÉ›ná¸·tÉª]", pos: "n. [C]", meaning: "æ‡²ç½°ï¼›åˆ‘ç½°", sentence: "If the company fails to deliver the goods on time, it may receive a penalty under the contract.", mnemonic: "Pen (ç­†) + alty (ç½°æ) -> è¢«ç½°æ‹¿ç­†æŠ„å¯« -> æ‡²ç½°" },
  { id: 3, word: "imprisonment", ipa: "[Éªm`prÉªzá¹‡mÉ™nt]", pos: "n. [U]", meaning: "ç›£ç¦", sentence: "The hacker was sentenced to eight yearsâ€™ imprisonment for stealing private data.", mnemonic: "Im (é€²å…¥) + prison (ç›£ç„) -> é€²å…¥ç›£ç„ -> ç›£ç¦" },
  { id: 4, word: "prison", ipa: "[`prÉªzá¹‡]", pos: "n. [U, C]", meaning: "ç›£ç„", sentence: "The man was sent to prison for ten years for armed robbery.", mnemonic: "Prison (éŸ³ä¼¼: æ€•äºº) -> è£¡é¢éƒ½æ˜¯å¯æ€•çš„äºº -> ç›£ç„" },
  { id: 5, word: "claim", ipa: "[klem]", pos: "n. [C]", meaning: "èªªæ³•ï¼›å®£ç¨±", sentence: "The influencer was criticized for making false claims about the product she was promoting.", mnemonic: "C (çœ‹) + laim (ä¾†) -> çœ‹èª°æ•¢ä¾†èªª -> å®£ç¨±" },
  { id: 6, word: "insist", ipa: "[Éªn`sÉªst]", pos: "vt. vi.", meaning: "å …æŒ", sentence: "Despite the cold weather outside, Tinaâ€™s little brother insisted that she take him to the park.", mnemonic: "In (åœ¨è£¡é¢) + sist (ç«™ç«‹) -> ç«™åœ¨ç«‹å ´è£¡ä¸å‹• -> å …æŒ" },
  { id: 7, word: "property", ipa: "[`prÉ‘pÉštÉª]", pos: "n. [U, C]", meaning: "åœ°ç”¢ï¼›æˆ¿åœ°ç”¢", sentence: "The farmer put up signs and fences to remind hikers that the field was his private property, not part of the public trail.", mnemonic: "Proper (é©ç•¶çš„) + ty -> å±¬æ–¼è‡ªå·±é©ç•¶çš„åœ°æ–¹ -> è²¡ç”¢/åœ°ç”¢" },
  { id: 8, word: "companion", ipa: "[kÉ™m`pÃ¦njÉ™n]", pos: "n. [C]", meaning: "åŒä¼´ï¼›å¤¥ä¼´", sentence: "I wanted a peaceful trip, but my traveling companion snored louder than the noise of the airplane engine.", mnemonic: "Com (ä¸€èµ·) + pan (éºµåŒ…) -> ä¸€èµ·åˆ†éºµåŒ…åƒçš„äºº -> åŒä¼´" },
  { id: 9, word: "mental", ipa: "[`mÉ›ntá¸·]", pos: "adj.", meaning: "å¿ƒç†çš„ï¼›ç²¾ç¥ä¸Šçš„", sentence: "The phrase â€œbe confidentâ€ gives me a mental image of myself trying to smile while panicking inside.", mnemonic: "Men (äºº) + tal (é ­) -> äººé ­è…¦è£¡çš„ -> å¿ƒç†çš„" },
  { id: 10, word: "devour", ipa: "[dÉª`vaÊŠr]", pos: "vt.", meaning: "ç†±åˆ‡åœ°è®€ï¼›ç‹¼åè™åš¥", sentence: "The detective devoured every word in the suspectâ€™s diary, hoping to find a clue hidden between the lines.", mnemonic: "De (å‘ä¸‹) + vour (å) -> æ•´å€‹åä¸‹å» -> ç‹¼åè™åš¥/ç†±åˆ‡åœ°è®€" },
  { id: 11, word: "volume", ipa: "[`vÉ‘ljÉ™m]", pos: "n. [C]", meaning: "æ›¸ç±ï¼›å·", sentence: "When I asked for a volume on time travel, the librarian looked at me as if I had lost my mind.", mnemonic: "Vo (å“‡) + lume (è·¯) -> å“‡! è·¯é‚Šå¥½å¤šæ›¸ -> æ›¸ç±/å·" },
  { id: 12, word: "acquire", ipa: "[É™`kwaÉªr]", pos: "vt.", meaning: "å­¸åˆ°ï¼›ç¿’å¾—", sentence: "Children usually acquire basic reading skills between ages six and eight.", mnemonic: "Ac (å») + quire (è¿½æ±‚) -> å»è¿½æ±‚å¾—åˆ° -> å­¸åˆ°/ç¿’å¾—" },
  { id: 13, word: "profound", ipa: "[prÉ™`faÊŠnd]", pos: "adj.", meaning: "æ·±åšçš„ï¼›è¦‹è§£æ·±é çš„", sentence: "Socrates is remembered as a profound thinker who questioned everything around him.", mnemonic: "Pro (å‘å‰) + found (ç™¼ç¾) -> å‘å‰ç™¼ç¾å¾ˆå¤šé“ç† -> æ·±é çš„" },
  { id: 14, word: "wealthy", ipa: "[`wÉ›lÎ¸Éª]", pos: "adj.", meaning: "å¯Œæœ‰çš„", sentence: "Since the luxurious hotel charges over US$20,000 a night, only very wealthy people can afford to stay there.", mnemonic: "Wealth (è²¡å¯Œ) + y -> æœ‰è²¡å¯Œçš„ -> å¯Œæœ‰çš„" },
  { id: 15, word: "murder", ipa: "[`mÉdÉš]", pos: "vt.", meaning: "è¬€æ®º", sentence: "The victim was found brutally murdered in her apartment, with no signs of forced entry.", mnemonic: "Mur (éŸ³ä¼¼: æ²’) + der (å¾·) -> æ²’å“å¾·çš„äº‹ -> è¬€æ®º" },
  { id: 16, word: "disgust", ipa: "[dÉªs`gÊŒst]", pos: "n. [U]", meaning: "å­æƒ¡ï¼›åæ„Ÿ", sentence: "Jennifer eats with her hands and spills food on her clothes, giving her brother a feeling of disgust.", mnemonic: "Dis (ä¸) + gust (å–œæ­¡/å‘³é“) -> ä¸å¥½çš„å‘³é“ -> å­æƒ¡" },
  { id: 17, word: "vain", ipa: "[ven]", pos: "adj.", meaning: "ç„¡ç”¨çš„ï¼›æ‰ç„¶çš„", sentence: "Hurley ran after the train in a vain attempt to catch it before it left the station.", mnemonic: "Vain (éŸ³ä¼¼: å®Œ) -> å…¨éƒ½å®Œäº† -> æ‰ç„¶çš„" },
  { id: 18, word: "worship", ipa: "[`wÉÊƒÉªp]", pos: "vt.", meaning: "å´‡æ‹œ", sentence: "Esther continued to worship her childhood hero even after learning about his criminal past.", mnemonic: "Wor (åƒ¹å€¼) + ship (èˆ¹/èº«åˆ†) -> è¦–ç‚ºæœ‰åƒ¹å€¼ -> å´‡æ‹œ" },
  { id: 19, word: "intention", ipa: "[Éªn`tÉ›nÊƒÉ™n]", pos: "n. [C]", meaning: "æ‰“ç®—ï¼›æ„åœ–", sentence: "It was not Jimâ€™s intention to scare the kids with his Halloween mask; he had just wanted to surprise them.", mnemonic: "In (å…§) + tent (å¸³ç¯·) -> åœ¨å¸³ç¯·å…§æƒ³è¨ˆç•« -> æ„åœ–" },
  { id: 20, word: "abandon", ipa: "[É™`bÃ¦ndÉ™n]", pos: "vt.", meaning: "ä¸­æ­¢ï¼›æ”¾æ£„", sentence: "Anthony abandoned his efforts to fix the old car after spending too much money on repairs.", mnemonic: "A (ä¸€å€‹) + ban (ç¦æ­¢) + don (åš) -> è¢«ç¦æ­¢åš -> æ”¾æ£„" },
  { id: 21, word: "surrender", ipa: "[sÉ™`rÉ›ndÉš]", pos: "vt.", meaning: "äº¤å‡ºï¼›æ”¾æ£„ï¼›æŠ•é™", sentence: "The general was forced to surrender the city to enemy forces after a long and costly battle.", mnemonic: "Sur (è¶…é) + render (çµ¦äºˆ) -> å…¨éƒ½çµ¦å‡ºå»äº† -> æŠ•é™/äº¤å‡º" },
  { id: 22, word: "guilt", ipa: "[gÉªlt]", pos: "n. [U]", meaning: "å…§ç–šï¼›ç½ªæƒ¡æ„Ÿ", sentence: "Many working parents feel a sense of guilt for being unable to spend more time with their children.", mnemonic: "Gui (é¬¼) + lt -> å¿ƒè£¡æœ‰é¬¼ -> å…§ç–š" },
  { id: 23, word: "rumor", ipa: "[`rumÉš]", pos: "n. [C, U]", meaning: "è¬ è¨€ï¼›å‚³è", sentence: "Rumors were flying that a popular video game was going to be adapted into a movie.", mnemonic: "Ru (å¦‚) + mor (é­”) -> å¦‚åŒé­”é¬¼èˆ¬æ•£æ’­ -> è¬ è¨€" },
];

// --- Utilities ---
const speak = (text, rate = 0.9) => {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = rate;
    window.speechSynthesis.speak(utterance);
  }
};

const getRandomItems = (arr, n) => {
  const shuffled = [...arr].sort(() => 0.5 - Math.random());
  return shuffled.slice(0, n);
};

// --- Components ---

// 1. Learning Mode
const LearningMode = ({ onUpdateProgress, progressData }) => {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isListening, setIsListening] = useState(false);
  const [feedback, setFeedback] = useState("");
  const currentWord = vocabularyData[currentIndex];

  const handleSpeechCheck = () => {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Edgeã€‚");
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    setIsListening(true);
    setFeedback("è«‹ç™¼éŸ³...");

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript.toLowerCase();
      const target = currentWord.word.toLowerCase();
      setIsListening(false);

      // Simple fuzzy match check
      if (transcript.includes(target) || target.includes(transcript)) {
        setFeedback("Correct! ğŸ‰");
        speak("Correct!");
        onUpdateProgress(currentWord.id);
      } else {
        setFeedback(`è½èµ·ä¾†åƒ: "${transcript}". å†è©¦ä¸€æ¬¡!`);
      }
    };

    recognition.onerror = (event) => {
      setIsListening(false);
      setFeedback("ç„¡æ³•è¾¨è­˜ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚");
    };

    recognition.onend = () => setIsListening(false);
    recognition.start();
  };

  const nextWord = () => setCurrentIndex(prev => (prev + 1) % vocabularyData.length);
  const prevWord = () => setCurrentIndex(prev => (prev - 1 + vocabularyData.length) % vocabularyData.length);

  return (
    <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6 min-h-[500px] flex flex-col">
      <div className="flex justify-between items-center mb-4 text-gray-500 text-sm">
        <span>Word {currentIndex + 1} of {vocabularyData.length}</span>
        <span>å·²æŒæ¡: {Object.keys(progressData).length} / {vocabularyData.length}</span>
      </div>

      <div className="flex-1 flex flex-col items-center text-center space-y-4">
        <h2 className="text-4xl font-bold text-indigo-600 mb-2">{currentWord.word}</h2>
        <div className="text-xl text-gray-600 font-mono bg-gray-100 px-3 py-1 rounded">{currentWord.ipa}</div>
        <div className="flex items-center gap-2">
           <span className="bg-indigo-100 text-indigo-800 text-sm font-medium px-2.5 py-0.5 rounded">{currentWord.pos}</span>
           <h3 className="text-2xl font-bold text-gray-800">{currentWord.meaning}</h3>
        </div>

        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 w-full text-left my-4">
          <p className="font-bold text-yellow-700">ğŸ’¡ è¨˜æ†¶æ³•ï¼š</p>
          <p className="text-gray-700">{currentWord.mnemonic}</p>
        </div>

        <div className="bg-gray-50 p-4 rounded-lg w-full text-left">
           <div className="flex justify-between items-start">
              <p className="text-lg text-gray-800 mb-2 leading-relaxed">{currentWord.sentence}</p>
              <button 
                onClick={() => speak(currentWord.sentence)}
                className="ml-2 p-2 bg-blue-100 rounded-full hover:bg-blue-200 text-blue-600 transition"
              >
                <Volume2 size={20} />
              </button>
           </div>
        </div>

        <div className="flex gap-4 mt-auto pt-6">
          <button onClick={() => speak(currentWord.word, 0.7)} className="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-full hover:bg-green-600 shadow transition">
            <Volume2 size={18} /> è½å–®å­—
          </button>
          
          <button 
            onClick={handleSpeechCheck} 
            className={`flex items-center gap-2 px-4 py-2 rounded-full shadow transition ${isListening ? 'bg-red-500 animate-pulse text-white' : 'bg-indigo-500 text-white hover:bg-indigo-600'}`}
          >
            <Mic size={18} /> {isListening ? "è†è½ä¸­..." : "ç™¼éŸ³æª¢æ¸¬"}
          </button>
        </div>
        
        {feedback && (
          <div className={`mt-3 font-bold ${feedback.includes("Correct") ? "text-green-600" : "text-red-500"}`}>
            {feedback}
          </div>
        )}
      </div>

      <div className="flex justify-between mt-8 pt-4 border-t">
        <button onClick={prevWord} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">ä¸Šä¸€å­—</button>
        <button onClick={nextWord} className="px-6 py-2 bg-gray-800 text-white rounded hover:bg-gray-700">ä¸‹ä¸€å­— <ArrowRight className="inline w-4 h-4 ml-1"/></button>
      </div>
    </div>
  );
};

// 2. Game 1: Matching
const GameMatching = ({ onComplete }) => {
  const [shuffledWords, setShuffledWords] = useState([]);
  const [shuffledMeanings, setShuffledMeanings] = useState([]);
  const [selectedWord, setSelectedWord] = useState(null);
  const [matched, setMatched] = useState([]);
  const [timeLeft, setTimeLeft] = useState(0);
  const [gameState, setGameState] = useState('intro'); // intro, playing, finished
  const timerRef = useRef(null);

  useEffect(() => {
    return () => clearInterval(timerRef.current);
  }, []);

  const startGame = () => {
    // Take all words
    const words = [...vocabularyData];
    // Shuffle left side
    setShuffledWords([...words].sort(() => Math.random() - 0.5));
    // Shuffle right side
    setShuffledMeanings([...words].sort(() => Math.random() - 0.5));
    setMatched([]);
    setSelectedWord(null);
    setTimeLeft(0);
    setGameState('playing');
    
    timerRef.current = setInterval(() => {
      setTimeLeft(t => t + 1);
    }, 1000);
  };

  const handleWordClick = (wordObj) => {
    if (selectedWord && selectedWord.type === 'meaning') {
      checkMatch(wordObj, selectedWord);
    } else {
      setSelectedWord({ ...wordObj, type: 'word' });
    }
  };

  const handleMeaningClick = (meaningObj) => {
    if (selectedWord && selectedWord.type === 'word') {
      checkMatch(selectedWord, meaningObj);
    } else {
      setSelectedWord({ ...meaningObj, type: 'meaning' });
    }
  };

  const checkMatch = (wordObj, meaningObj) => {
    if (wordObj.id === meaningObj.id) {
      const newMatched = [...matched, wordObj.id];
      setMatched(newMatched);
      setSelectedWord(null);
      if (newMatched.length === vocabularyData.length) {
        endGame(true);
      }
    } else {
      setSelectedWord(null); // Reset on wrong match
      // Optional: Add visual error feedback here
    }
  };

  const endGame = (success) => {
    clearInterval(timerRef.current);
    setGameState('finished');
    onComplete({
      passed: timeLeft <= 60,
      score: timeLeft, // Lower is better
      total: vocabularyData.length
    });
  };

  if (gameState === 'intro') return (
    <div className="text-center py-10">
      <h3 className="text-2xl font-bold mb-4">å–®å­—é…å°æŒ‘æˆ°</h3>
      <p className="mb-6">è«‹å°‡å·¦é‚Šçš„è‹±æ–‡å–®å­—èˆ‡å³é‚Šçš„ä¸­æ–‡è§£é‡‹é…å°ã€‚<br/>ç›®æ¨™ï¼šåœ¨ <span className="text-red-500 font-bold">60ç§’</span> å…§å®Œæˆï¼</p>
      <button onClick={startGame} className="px-8 py-3 bg-indigo-600 text-white rounded-lg shadow-lg hover:bg-indigo-700 text-lg font-bold">
        é–‹å§‹è¨ˆæ™‚
      </button>
    </div>
  );

  if (gameState === 'finished') return (
    <div className="text-center py-10">
      <h3 className="text-3xl font-bold mb-4">{timeLeft <= 60 ? "æŒ‘æˆ°æˆåŠŸ! ğŸ‰" : "é€¾æ™‚äº†! ğŸ˜…"}</h3>
      <p className="text-xl mb-6">ä½ çš„æ™‚é–“: {timeLeft} ç§’</p>
      <button onClick={startGame} className="flex items-center justify-center mx-auto gap-2 px-6 py-2 bg-gray-200 rounded hover:bg-gray-300">
        <RotateCcw size={18} /> å†è©¦ä¸€æ¬¡
      </button>
    </div>
  );

  return (
    <div className="max-w-4xl mx-auto">
      <div className="flex justify-between items-center mb-4 px-4 sticky top-0 bg-gray-50 p-2 z-10 shadow-sm">
        <h3 className="font-bold text-gray-700">é…å°éŠæˆ²</h3>
        <div className={`text-xl font-mono font-bold ${timeLeft > 60 ? 'text-red-500' : 'text-green-600'}`}>
          <Clock className="inline mr-2" />
          {Math.floor(timeLeft / 60)}:{String(timeLeft % 60).padStart(2, '0')}
        </div>
      </div>
      
      <div className="grid grid-cols-2 gap-4">
        <div className="space-y-2">
          {shuffledWords.map(w => (
            !matched.includes(w.id) && (
              <button
                key={w.id}
                onClick={() => handleWordClick(w)}
                className={`w-full p-3 text-left border rounded transition-all ${selectedWord?.id === w.id && selectedWord.type === 'word' ? 'bg-indigo-100 border-indigo-500 ring-2 ring-indigo-300' : 'bg-white hover:bg-gray-50'}`}
              >
                {w.word}
              </button>
            )
          ))}
        </div>
        <div className="space-y-2">
          {shuffledMeanings.map(m => (
            !matched.includes(m.id) && (
              <button
                key={m.id}
                onClick={() => handleMeaningClick(m)}
                className={`w-full p-3 text-left border rounded transition-all ${selectedWord?.id === m.id && selectedWord.type === 'meaning' ? 'bg-indigo-100 border-indigo-500 ring-2 ring-indigo-300' : 'bg-white hover:bg-gray-50'}`}
              >
                {m.meaning}
              </button>
            )
          ))}
        </div>
      </div>
    </div>
  );
};

// 3. Game 2: Listening
const GameListening = ({ onComplete, recordWrongWord }) => {
  const [questions, setQuestions] = useState([]);
  const [currentQIndex, setCurrentQIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [gameState, setGameState] = useState('intro'); // intro, playing, finished, feedback
  const [selectedOption, setSelectedOption] = useState(null);

  const startGame = () => {
    // Generate 15 questions
    const pool = getRandomItems(vocabularyData, 15);
    const qs = pool.map(target => {
      // Get 3 random distractors
      const distractors = getRandomItems(vocabularyData.filter(w => w.id !== target.id), 3);
      const options = getRandomItems([target, ...distractors], 4);
      return { target, options };
    });
    setQuestions(qs);
    setCurrentQIndex(0);
    setScore(0);
    setGameState('playing');
    // Auto play first audio with slight delay
    setTimeout(() => speak(qs[0].target.word), 500);
  };

  const handleOptionClick = (option) => {
    if (gameState !== 'playing') return;
    setSelectedOption(option);
    
    const isCorrect = option.id === questions[currentQIndex].target.id;
    if (isCorrect) {
      setScore(s => s + 1);
    } else {
      recordWrongWord(questions[currentQIndex].target.id);
    }

    setGameState('feedback');
    
    setTimeout(() => {
      if (currentQIndex < 14) {
        setCurrentQIndex(prev => prev + 1);
        setGameState('playing');
        setSelectedOption(null);
        speak(questions[currentQIndex + 1].target.word);
      } else {
        const finalScore = isCorrect ? score + 1 : score;
        onComplete({ passed: finalScore >= 10, score: finalScore, total: 15 });
        setGameState('finished');
      }
    }, 1500);
  };

  if (gameState === 'intro') return (
    <div className="text-center py-10">
      <h3 className="text-2xl font-bold mb-4">è½è‹±é¸ä¸­</h3>
      <p className="mb-6">è†è½å–®å­—ç™¼éŸ³ï¼Œé¸å‡ºæ­£ç¢ºçš„ä¸­æ–‡è§£é‡‹ã€‚<br/>å…±15é¡Œï¼Œç­”å° <span className="text-green-600 font-bold">10é¡Œ</span> éé—œã€‚</p>
      <button onClick={startGame} className="px-8 py-3 bg-indigo-600 text-white rounded-lg shadow-lg hover:bg-indigo-700 text-lg font-bold">é–‹å§‹æŒ‘æˆ°</button>
    </div>
  );

  if (gameState === 'finished') return (
    <div className="text-center py-10">
      <h3 className="text-2xl font-bold mb-4">æ¸¬é©—çµæŸ</h3>
      <div className="text-4xl font-bold mb-2 text-indigo-600">{score} / 15</div>
      <p className="mb-6">{score >= 10 ? "æ­å–œéé—œ! ğŸ‰" : "è«‹å†æ¥å†å² ğŸ’ª"}</p>
      <button onClick={startGame} className="flex items-center justify-center mx-auto gap-2 px-6 py-2 bg-gray-200 rounded hover:bg-gray-300">
        <RotateCcw size={18} /> å†è©¦ä¸€æ¬¡
      </button>
    </div>
  );

  const currentQ = questions[currentQIndex];

  return (
    <div className="max-w-2xl mx-auto">
      <div className="flex justify-between items-center mb-6">
        <span className="text-sm font-bold text-gray-500">Q: {currentQIndex + 1} / 15</span>
        <span className="text-sm font-bold text-indigo-600">Score: {score}</span>
      </div>

      <div className="flex flex-col items-center mb-8">
        <button 
          onClick={() => speak(currentQ.target.word)}
          className="w-24 h-24 rounded-full bg-indigo-100 hover:bg-indigo-200 text-indigo-600 flex items-center justify-center transition-transform hover:scale-110 shadow-md"
        >
          <Volume2 size={40} />
        </button>
        <p className="mt-2 text-gray-500 text-sm">é»æ“Šæ’­æ”¾è²éŸ³</p>
      </div>

      <div className="grid grid-cols-1 gap-3">
        {currentQ.options.map(opt => {
          let btnClass = "p-4 text-lg border-2 rounded-xl text-left transition-all font-medium ";
          if (gameState === 'feedback') {
            if (opt.id === currentQ.target.id) btnClass += "bg-green-100 border-green-500 text-green-800";
            else if (opt.id === selectedOption?.id) btnClass += "bg-red-100 border-red-500 text-red-800";
            else btnClass += "bg-white border-gray-200 opacity-50";
          } else {
            btnClass += "bg-white border-gray-200 hover:border-indigo-400 hover:bg-indigo-50 cursor-pointer";
          }

          return (
            <button 
              key={opt.id}
              disabled={gameState === 'feedback'}
              onClick={() => handleOptionClick(opt)}
              className={btnClass}
            >
              {opt.meaning}
              {gameState === 'feedback' && opt.id === currentQ.target.id && (
                <span className="float-right text-sm font-bold bg-white px-2 rounded text-green-600 border border-green-200">{currentQ.target.word}</span>
              )}
            </button>
          );
        })}
      </div>
    </div>
  );
};

// 4. Game 3: Cloze
const GameCloze = ({ onComplete, recordWrongWord }) => {
  const [questions, setQuestions] = useState([]);
  const [currentQIndex, setCurrentQIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [gameState, setGameState] = useState('intro');
  const [selectedOption, setSelectedOption] = useState(null);

  const startGame = () => {
    const pool = getRandomItems(vocabularyData, 15);
    const qs = pool.map(target => {
      const distractors = getRandomItems(vocabularyData.filter(w => w.id !== target.id), 3);
      const options = getRandomItems([target, ...distractors], 4);
      
      // Create cloze sentence (simple case-insensitive replacement of word and its basic variations)
      // Note: This is a simple regex replacer.
      const regex = new RegExp(target.word + "[a-z]*", "gi");
      const clozeSentence = target.sentence.replace(regex, "_______");
      
      return { target, options, clozeSentence };
    });
    setQuestions(qs);
    setCurrentQIndex(0);
    setScore(0);
    setGameState('playing');
  };

  const handleOptionClick = (option) => {
    if (gameState !== 'playing') return;
    setSelectedOption(option);
    
    const isCorrect = option.id === questions[currentQIndex].target.id;
    if (isCorrect) {
      setScore(s => s + 1);
    } else {
      recordWrongWord(questions[currentQIndex].target.id);
    }

    setGameState('feedback');
    
    setTimeout(() => {
      if (currentQIndex < 14) {
        setCurrentQIndex(prev => prev + 1);
        setGameState('playing');
        setSelectedOption(null);
      } else {
        const finalScore = isCorrect ? score + 1 : score;
        onComplete({ passed: finalScore >= 10, score: finalScore, total: 15 });
        setGameState('finished');
      }
    }, 2000);
  };

  if (gameState === 'intro') return (
    <div className="text-center py-10">
      <h3 className="text-2xl font-bold mb-4">æ–‡æ„å¡«ç©º</h3>
      <p className="mb-6">é–±è®€ä¾‹å¥ï¼Œé¸å‡ºæ­£ç¢ºçš„å–®å­—å¡«å…¥ç©ºæ ¼ã€‚<br/>å…±15é¡Œï¼Œç­”å° <span className="text-green-600 font-bold">10é¡Œ</span> éé—œã€‚</p>
      <button onClick={startGame} className="px-8 py-3 bg-indigo-600 text-white rounded-lg shadow-lg hover:bg-indigo-700 text-lg font-bold">é–‹å§‹æŒ‘æˆ°</button>
    </div>
  );

  if (gameState === 'finished') return (
    <div className="text-center py-10">
      <h3 className="text-2xl font-bold mb-4">æ¸¬é©—çµæŸ</h3>
      <div className="text-4xl font-bold mb-2 text-indigo-600">{score} / 15</div>
      <p className="mb-6">{score >= 10 ? "æ­å–œéé—œ! ğŸ‰" : "è«‹å†æ¥å†å² ğŸ’ª"}</p>
      <button onClick={startGame} className="flex items-center justify-center mx-auto gap-2 px-6 py-2 bg-gray-200 rounded hover:bg-gray-300">
        <RotateCcw size={18} /> å†è©¦ä¸€æ¬¡
      </button>
    </div>
  );

  const currentQ = questions[currentQIndex];

  return (
    <div className="max-w-2xl mx-auto">
      <div className="flex justify-between items-center mb-6">
        <span className="text-sm font-bold text-gray-500">Q: {currentQIndex + 1} / 15</span>
        <span className="text-sm font-bold text-indigo-600">Score: {score}</span>
      </div>

      <div className="bg-white p-6 rounded-xl shadow-md mb-8 min-h-[120px] flex items-center justify-center">
        <p className="text-xl text-gray-800 font-medium leading-relaxed">
           {gameState === 'feedback' 
             ? currentQ.target.sentence.split(' ').map((word, i) => {
                 if (word.toLowerCase().includes(currentQ.target.word.toLowerCase())) {
                   return <span key={i} className="text-green-600 font-bold underline mx-1">{word}</span>
                 }
                 return word + " ";
               })
             : currentQ.clozeSentence
           }
        </p>
      </div>

      <div className="grid grid-cols-2 gap-3">
        {currentQ.options.map(opt => {
          let btnClass = "p-4 text-lg border-2 rounded-xl text-center transition-all font-bold ";
           if (gameState === 'feedback') {
            if (opt.id === currentQ.target.id) btnClass += "bg-green-100 border-green-500 text-green-800";
            else if (opt.id === selectedOption?.id) btnClass += "bg-red-100 border-red-500 text-red-800";
            else btnClass += "bg-white border-gray-200 opacity-50";
          } else {
            btnClass += "bg-white border-gray-200 hover:border-indigo-400 hover:bg-indigo-50 cursor-pointer";
          }

          return (
            <button 
              key={opt.id}
              disabled={gameState === 'feedback'}
              onClick={() => handleOptionClick(opt)}
              className={btnClass}
            >
              {opt.word}
            </button>
          );
        })}
      </div>
    </div>
  );
};

// 5. Report Card
const ReportCard = ({ stats, wrongCounts, progressData }) => {
  const [serialId] = useState(() => Math.random().toString(36).substr(2, 9).toUpperCase());
  
  const weakWords = Object.entries(wrongCounts)
    .sort(([, a], [, b]) => b - a)
    .slice(0, 5)
    .map(([id]) => vocabularyData.find(w => w.id === parseInt(id)));

  const isComplete = stats.game1.passed && stats.game2.passed && stats.game3.passed;

  return (
    <div className="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-xl border-t-8 border-indigo-600">
      <div className="text-center border-b pb-4 mb-6">
        <h2 className="text-3xl font-bold text-gray-800">L1 å–®å­—å­¸ç¿’æˆç¸¾å–®</h2>
        <p className="text-gray-500 mt-2">æµæ°´è™Ÿ: <span className="font-mono bg-gray-100 px-2 rounded">{serialId}</span></p>
      </div>

      <div className="space-y-6">
        <div>
          <h3 className="font-bold text-gray-700 mb-2 flex items-center"><Mic className="mr-2" size={20}/> ç™¼éŸ³æª¢æ¸¬é€²åº¦</h3>
          <div className="w-full bg-gray-200 rounded-full h-4">
            <div 
              className="bg-blue-500 h-4 rounded-full transition-all duration-1000" 
              style={{ width: `${(Object.keys(progressData).length / vocabularyData.length) * 100}%` }}
            ></div>
          </div>
          <p className="text-right text-sm text-gray-600 mt-1">{Object.keys(progressData).length} / {vocabularyData.length} å®Œæˆ</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
           <div className={`p-4 rounded-lg border-2 ${stats.game1.passed ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-gray-50'}`}>
              <div className="text-center font-bold text-gray-700 mb-1">é…å°éŠæˆ²</div>
              <div className="text-center text-2xl">
                 {stats.game1.passed ? <span className="text-green-600">PASS</span> : <span className="text-gray-400">æœªéé—œ</span>}
              </div>
              <div className="text-center text-sm text-gray-500">{stats.game1.score ? `${stats.game1.score}ç§’` : '--'}</div>
           </div>
           <div className={`p-4 rounded-lg border-2 ${stats.game2.passed ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-gray-50'}`}>
              <div className="text-center font-bold text-gray-700 mb-1">è½åŠ›æ¸¬é©—</div>
              <div className="text-center text-2xl">
                 {stats.game2.passed ? <span className="text-green-600">PASS</span> : <span className="text-gray-400">æœªéé—œ</span>}
              </div>
              <div className="text-center text-sm text-gray-500">{stats.game2.score !== null ? `${stats.game2.score}/15` : '--'}</div>
           </div>
           <div className={`p-4 rounded-lg border-2 ${stats.game3.passed ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-gray-50'}`}>
              <div className="text-center font-bold text-gray-700 mb-1">æ–‡æ„å¡«ç©º</div>
              <div className="text-center text-2xl">
                 {stats.game3.passed ? <span className="text-green-600">PASS</span> : <span className="text-gray-400">æœªéé—œ</span>}
              </div>
              <div className="text-center text-sm text-gray-500">{stats.game3.score !== null ? `${stats.game3.score}/15` : '--'}</div>
           </div>
        </div>

        {weakWords.length > 0 && (
          <div className="bg-red-50 p-4 rounded-lg border border-red-100">
            <h3 className="font-bold text-red-800 mb-2">âš ï¸ éœ€è¦åŠ å¼·çš„å–®å­— (å‰5å)</h3>
            <ul className="list-disc pl-5 space-y-1 text-red-700">
              {weakWords.map(w => (
                <li key={w.id}>{w.word} ({w.meaning})</li>
              ))}
            </ul>
          </div>
        )}
      </div>

      <div className="mt-8 text-center">
        {isComplete ? (
           <div className="bg-green-100 text-green-800 p-4 rounded-lg mb-4 flex items-center justify-center gap-2">
             <Trophy size={24} className="text-yellow-600"/>
             <span className="font-bold">æ­å–œå®Œæˆæ‰€æœ‰ä»»å‹™ï¼è«‹æˆªåœ–æ­¤ç•«é¢å‚³çµ¦è€å¸«ã€‚</span>
           </div>
        ) : (
           <div className="bg-yellow-100 text-yellow-800 p-3 rounded-lg mb-4 flex items-center justify-center gap-2">
             <AlertCircle size={20}/>
             <span>å°šæœªé€šéæ‰€æœ‰é—œå¡ï¼Œè«‹ç¹¼çºŒåŠ æ²¹ï¼</span>
           </div>
        )}
      </div>
    </div>
  );
};

// --- Main App Component ---

const App = () => {
  const [mode, setMode] = useState('menu'); // menu, learning, practice, report
  const [subMode, setSubMode] = useState(null); // game1, game2, game3
  
  // Stats
  const [progressData, setProgressData] = useState({}); // { wordId: true }
  const [wrongCounts, setWrongCounts] = useState({}); // { wordId: count }
  const [gameStats, setGameStats] = useState({
    game1: { passed: false, score: null },
    game2: { passed: false, score: null },
    game3: { passed: false, score: null },
  });

  const handleUpdateProgress = (id) => {
    setProgressData(prev => ({ ...prev, [id]: true }));
  };

  const recordWrong = (id) => {
    setWrongCounts(prev => ({ ...prev, [id]: (prev[id] || 0) + 1 }));
  };

  const updateGameStats = (game, result) => {
    setGameStats(prev => ({
      ...prev,
      [game]: { passed: result.passed, score: result.score }
    }));
    // After finishing a game, go back to practice menu
    setTimeout(() => setSubMode(null), 100); 
  };

  const renderContent = () => {
    if (mode === 'learning') {
      return (
        <div>
           <div className="flex items-center mb-4">
             <button onClick={() => setMode('menu')} className="text-gray-500 hover:text-gray-800 flex items-center">
               <Home size={20} className="mr-1"/> å›é¦–é 
             </button>
           </div>
           <LearningMode onUpdateProgress={handleUpdateProgress} progressData={progressData} />
        </div>
      );
    }

    if (mode === 'report') {
      return (
        <div>
           <div className="flex items-center mb-4">
             <button onClick={() => setMode('menu')} className="text-gray-500 hover:text-gray-800 flex items-center">
               <Home size={20} className="mr-1"/> å›é¦–é 
             </button>
           </div>
           <ReportCard stats={gameStats} wrongCounts={wrongCounts} progressData={progressData} />
        </div>
      );
    }

    if (mode === 'practice') {
       if (subMode === 'game1') return (
         <div>
            <button onClick={() => setSubMode(null)} className="mb-4 text-gray-500 hover:text-gray-800">â† è¿”å›ç·´ç¿’é¸å–®</button>
            <GameMatching onComplete={(res) => updateGameStats('game1', res)} />
         </div>
       );
       if (subMode === 'game2') return (
         <div>
            <button onClick={() => setSubMode(null)} className="mb-4 text-gray-500 hover:text-gray-800">â† è¿”å›ç·´ç¿’é¸å–®</button>
            <GameListening onComplete={(res) => updateGameStats('game2', res)} recordWrongWord={recordWrong} />
         </div>
       );
       if (subMode === 'game3') return (
         <div>
            <button onClick={() => setSubMode(null)} className="mb-4 text-gray-500 hover:text-gray-800">â† è¿”å›ç·´ç¿’é¸å–®</button>
            <GameCloze onComplete={(res) => updateGameStats('game3', res)} recordWrongWord={recordWrong} />
         </div>
       );

       return (
         <div className="max-w-md mx-auto space-y-4">
            <button onClick={() => setMode('menu')} className="text-gray-500 hover:text-gray-800 mb-2 flex items-center">
               <Home size={20} className="mr-1"/> å›é¦–é 
            </button>
            <h2 className="text-2xl font-bold text-center mb-6">ç·´ç¿’æ¨¡å¼é¸å–®</h2>
            
            <button onClick={() => setSubMode('game1')} className="w-full p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition border-l-4 border-yellow-400 flex justify-between items-center group">
              <div className="text-left">
                <div className="font-bold text-xl text-gray-800 group-hover:text-yellow-600">å–®å­—é…å°</div>
                <div className="text-sm text-gray-500">é™æ™‚60ç§’æŒ‘æˆ°</div>
              </div>
              {gameStats.game1.passed ? <Check className="text-green-500" /> : <ArrowRight className="text-gray-300 group-hover:text-yellow-500"/>}
            </button>

            <button onClick={() => setSubMode('game2')} className="w-full p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition border-l-4 border-blue-400 flex justify-between items-center group">
              <div className="text-left">
                <div className="font-bold text-xl text-gray-800 group-hover:text-blue-600">è½è‹±é¸ä¸­</div>
                <div className="text-sm text-gray-500">è½åŠ›å¤§è€ƒé©— (10/15éé—œ)</div>
              </div>
              {gameStats.game2.passed ? <Check className="text-green-500" /> : <ArrowRight className="text-gray-300 group-hover:text-blue-500"/>}
            </button>

            <button onClick={() => setSubMode('game3')} className="w-full p-6 bg-white rounded-xl shadow-md hover:shadow-lg transition border-l-4 border-purple-400 flex justify-between items-center group">
              <div className="text-left">
                <div className="font-bold text-xl text-gray-800 group-hover:text-purple-600">æ–‡æ„å¡«ç©º</div>
                <div className="text-sm text-gray-500">ä¾‹å¥å¯¦æˆ° (10/15éé—œ)</div>
              </div>
              {gameStats.game3.passed ? <Check className="text-green-500" /> : <ArrowRight className="text-gray-300 group-hover:text-purple-500"/>}
            </button>

            <div className="mt-8 text-center p-4 bg-gray-50 rounded-lg">
               <p className="text-sm text-gray-600 mb-2">å®Œæˆä¸‰é—œå¾Œå³å¯é ˜å–æˆç¸¾å–®</p>
               <button 
                 onClick={() => setMode('report')}
                 disabled={!gameStats.game1.passed || !gameStats.game2.passed || !gameStats.game3.passed}
                 className={`px-6 py-2 rounded-full font-bold shadow ${gameStats.game1.passed && gameStats.game2.passed && gameStats.game3.passed ? 'bg-gradient-to-r from-green-400 to-blue-500 text-white hover:scale-105 transition' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
               >
                 é ˜å–æˆç¸¾å–®
               </button>
            </div>
         </div>
       );
    }

    // Default: Main Menu
    return (
      <div className="max-w-4xl mx-auto text-center space-y-8 pt-10">
        <h1 className="text-4xl md:text-5xl font-extrabold text-indigo-700 tracking-tight">
          L1 Vocabulary Master <span className="text-yellow-500">23</span>
        </h1>
        <p className="text-xl text-gray-600">è®“èƒŒå–®å­—è®Šå¾—æœ‰è¶£åˆæœ‰æ•ˆç‡ï¼</p>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto mt-12">
          <button 
            onClick={() => setMode('learning')}
            className="flex flex-col items-center p-8 bg-white rounded-2xl shadow-xl hover:shadow-2xl hover:-translate-y-1 transition border-t-8 border-cyan-400"
          >
            <div className="bg-cyan-100 p-4 rounded-full mb-4 text-cyan-600">
               <Play size={40} fill="currentColor" />
            </div>
            <h2 className="text-2xl font-bold text-gray-800">A. å­¸ç¿’æ¨¡å¼</h2>
            <p className="text-gray-500 mt-2">å–®å­—å¡ã€è«§éŸ³è¨˜æ†¶ã€ç™¼éŸ³æª¢æ¸¬</p>
          </button>

          <button 
            onClick={() => setMode('practice')}
            className="flex flex-col items-center p-8 bg-white rounded-2xl shadow-xl hover:shadow-2xl hover:-translate-y-1 transition border-t-8 border-pink-400"
          >
            <div className="bg-pink-100 p-4 rounded-full mb-4 text-pink-600">
               <Trophy size={40} />
            </div>
            <h2 className="text-2xl font-bold text-gray-800">B. ç·´ç¿’æ¨¡å¼</h2>
            <p className="text-gray-500 mt-2">é…å°ã€è½åŠ›ã€å¡«ç©ºä¸‰é—œå¡</p>
          </button>
        </div>

        <div className="mt-8">
           <button onClick={() => setMode('report')} className="text-gray-500 underline text-sm hover:text-indigo-600">
             æŸ¥çœ‹ç›®å‰æˆç¸¾å–®ç‹€æ…‹
           </button>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gray-100 p-4 md:p-8 font-sans">
      {renderContent()}
    </div>
  );
};

export default App;